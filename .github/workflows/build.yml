name: Build LEDE for Newifi D2

on:
  workflow_dispatch:
  schedule:
    - cron: "0 20 * * 5"   # 每周五 UTC 20:00（新加坡+8 是周六 04:00）
  push:
    paths:
      - ".github/workflows/build.yml"
      - "diy.sh"
      - "files/**"
      - ".config"

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Init build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
            gettext git libncurses5-dev libssl-dev python3 python3-distutils rsync unzip zlib1g-dev \
            file wget

      - name: Clone lede source
        run: |
          git clone --depth=1 https://github.com/coolsnowwolf/lede.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply DIY
        run: |
          cd openwrt
          if [ -f "${GITHUB_WORKSPACE}/diy.sh" ]; then
            bash "${GITHUB_WORKSPACE}/diy.sh"
          fi

      # 你可以把你自己的 .config 放在仓库根目录
      - name: Load config
        run: |
          cd openwrt
          if [ -f "${GITHUB_WORKSPACE}/.config" ]; then
            cp "${GITHUB_WORKSPACE}/.config" .config
          else
            printf '%s\n' \
              'CONFIG_TARGET_ramips=y' \
              'CONFIG_TARGET_ramips_mt7621=y' \
              'CONFIG_TARGET_ramips_mt7621_DEVICE_d-team_newifi-d2=y' \
              'CONFIG_PACKAGE_luci=y' \
              'CONFIG_PACKAGE_luci-ssl=y' \
              > .config
          fi
          make defconfig

      # 缓存 dl 和 build 目录（加速明显）
      - name: Cache
        uses: actions/cache@v4
        with:
          path: |
            openwrt/dl
            openwrt/build_dir
            openwrt/staging_dir
          key: ${{ runner.os }}-lede-${{ hashFiles('openwrt/.config') }}
          restore-keys: |
            ${{ runner.os }}-lede-

      - name: Download package sources
        run: |
          cd openwrt
          make download -j8 V=s

      - name: Compile firmware
        run: |
          cd openwrt
          make -j"$(nproc)" V=s

      - name: Collect artifacts
        run: |
          mkdir -p artifact
          cp -v openwrt/bin/targets/ramips/mt7621/*sysupgrade.bin artifact/ || true
          cp -v openwrt/bin/targets/ramips/mt7621/*factory.bin artifact/ || true
          ls -lah artifact || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lede-newifi-d2
          path: artifact
